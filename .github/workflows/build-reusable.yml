name: Build WebKit (Reusable)

env:
  LLVM_VERSION: 19

on:
  workflow_call:
    inputs:
      webkit_sha:
        description: 'WebKit commit SHA to build'
        type: string
        required: true
      release_tag:
        description: 'Release tag name'
        type: string
        required: true
      is_prerelease:
        description: 'Mark release as prerelease'
        type: boolean
        default: false
      llvm_version:
        description: 'LLVM version to use'
        type: string
        default: '19'
    outputs:
      release_tag:
        description: 'The release tag that was created'
        value: ${{ jobs.release.outputs.tag }}

jobs:
  macos:
    name: macOS
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13-large
            cpp_flags: "-D_LIBCXX_ENABLE_ASSERTIONS=1"
            cpu: haswell
            label: bun-webkit-macos-amd64-debug
            brew_prefix: /usr/local/opt
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: Debug
          - runner: macos-14-xlarge
            cpp_flags: "-D_LIBCXX_ENABLE_ASSERTIONS=1"
            cpu: native
            label: bun-webkit-macos-arm64-debug
            brew_prefix: /opt/homebrew/opt
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: Debug
          - runner: macos-14-xlarge
            cpp_flags: "-D_LIBCXX_ENABLE_ASSERTIONS=1"
            cpu: native
            label: bun-webkit-macos-arm64-debug-asan
            brew_prefix: /opt/homebrew/opt
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: Debug
            ENABLE_MALLOC_HEAP_BREAKDOWN: "OFF"
            ENABLE_SANITIZERS: "address,undefined"
          - runner: macos-13-large
            cpp_flags: ""
            cpu: haswell
            label: bun-webkit-macos-amd64
            brew_prefix: /usr/local/opt
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: Release
          - runner: macos-14-xlarge
            cpp_flags: "-D_LIBCXX_ENABLE_ASSERTIONS=0"
            cpu: native
            label: bun-webkit-macos-arm64
            brew_prefix: /opt/homebrew/opt
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: Release
          - runner: macos-14-xlarge
            cpp_flags: "-D_LIBCXX_ENABLE_ASSERTIONS=1"
            cpu: native
            label: bun-webkit-macos-arm64-asan
            brew_prefix: /opt/homebrew/opt
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: Release
            ENABLE_SANITIZERS: "address,undefined"
    steps:
      - name: Checkout libbun-webkit
        uses: actions/checkout@v4
        with:
          path: libbun-webkit
      
      - name: Clone WebKit
        uses: actions/checkout@v4
        with:
          repository: oven-sh/WebKit
          ref: ${{ inputs.webkit_sha }}
          path: webkit
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            /*
            !LayoutTests/
            !JSTests/
      
      - name: Apply patches
        run: |
          cd webkit
          for patch in ${{ github.workspace }}/libbun-webkit/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying patch: $patch"
              git apply "$patch" || git apply --3way "$patch" 2>/dev/null || echo "Patch $patch may not apply cleanly"
            fi
          done

      - name: Set LLVM version
        run: echo "LLVM_VERSION=${{ inputs.llvm_version }}" >> $GITHUB_ENV

      - name: Install dependencies
        env:
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
          HOMEBREW_NO_ANALYTICS_THIS_RUN: 1
        run: |
          echo "${{matrix.brew_prefix}}/llvm@${{env.LLVM_VERSION}}/bin" >> $GITHUB_PATH
          brew install llvm@${{env.LLVM_VERSION}} python icu4c ninja -f --overwrite
          brew link llvm@${{env.LLVM_VERSION}} -f --overwrite

      - name: Build WebKit
        env:
          ICU_INCLUDE_DIRS: ${{matrix.brew_prefix}}/icu4c/include
          LDFLAGS: "${{env.LDFLAGS}} "
          CC: "${{matrix.brew_prefix}}/llvm@${{env.LLVM_VERSION}}/bin/clang"
          CXX: "${{matrix.brew_prefix}}/llvm@${{env.LLVM_VERSION}}/bin/clang++"
          RANLIB: "${{matrix.brew_prefix}}/llvm@${{env.LLVM_VERSION}}/bin/llvm-ranlib"
          AR: "${{matrix.brew_prefix}}/llvm@${{env.LLVM_VERSION}}/bin/llvm-ar"
          CMAKE_C_COMPILER: "${{matrix.brew_prefix}}/llvm@${{env.LLVM_VERSION}}/bin/clang"
          CMAKE_CXX_COMPILER: "${{matrix.brew_prefix}}/llvm@${{env.LLVM_VERSION}}/bin/clang++"
          CMAKE_C_FLAGS: " -fno-exceptions ${{matrix.cpp_flags}} -fvisibility=hidden -fvisibility-inlines-hidden -O3 -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -faddrsig "
          CMAKE_CXX_FLAGS: " -fno-exceptions ${{matrix.cpp_flags}} -fvisibility=hidden -fvisibility-inlines-hidden -O3 -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -faddrsig -fno-c++-static-destructors "
          CMAKE_OSX_DEPLOYMENT_TARGET: "13.0"
          CMAKE_BUILD_TYPE: ${{matrix.CMAKE_BUILD_TYPE}}
          PACKAGE_JSON_ARCH: ${{matrix.package_json_arch}}
          PACKAGE_JSON_LABEL: ${{matrix.label}}
          ENABLE_MALLOC_HEAP_BREAKDOWN: ${{matrix.ENABLE_MALLOC_HEAP_BREAKDOWN}}
          ENABLE_SANITIZERS: ${{matrix.ENABLE_SANITIZERS}}
        working-directory: webkit
        run: |
          export GITHUB_REPOSITORY=${{ github.repository }}
          export GITHUB_SHA=${{ inputs.webkit_sha }}
          bash mac-release.bash

      - uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.label}}
          path: ${{runner.temp}}/bun-webkit.tar.gz

  linux:
    name: Linux
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - lto_flag: ""
            label: bun-webkit-linux-amd64-debug
            os: ubuntu-latest
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: "Debug"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
          - lto_flag: ""
            label: bun-webkit-linux-arm64-debug
            os: ubuntu-24.04-arm
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: "Debug"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
          - lto_flag: ""
            label: bun-webkit-linux-arm64-debug-asan
            os: ubuntu-24.04-arm
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: "Debug"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
            ENABLE_SANITIZERS: "address,undefined"
          - lto_flag: ""
            label: bun-webkit-linux-amd64-debug-asan
            os: ubuntu-latest
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: "Debug"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
            ENABLE_SANITIZERS: "address,undefined"
          # LTO builds commented out - require more memory than GitHub runners provide
          # - lto_flag: "-flto=full -fwhole-program-vtables -fforce-emit-vtables"
          #   label: bun-webkit-linux-arm64-lto
          #   os: ubuntu-24.04-arm
          #   package_json_arch: "arm64"
          #   CMAKE_BUILD_TYPE: "Release"
          #   RELEASE_FLAGS: "-O3 -DNDEBUG=1"
          - lto_flag: ""
            label: bun-webkit-linux-arm64
            os: ubuntu-24.04-arm
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: "Release"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
          # - lto_flag: "-flto=full -fwhole-program-vtables -fforce-emit-vtables"
          #   label: bun-webkit-linux-amd64-lto
          #   os: ubuntu-latest
          #   package_json_arch: "x64"
          #   CMAKE_BUILD_TYPE: "Release"
          #   RELEASE_FLAGS: "-O3 -DNDEBUG=1"
          - lto_flag: ""
            label: bun-webkit-linux-amd64
            os: ubuntu-latest
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: "Release"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
          - lto_flag: ""
            label: bun-webkit-linux-amd64-asan
            os: ubuntu-latest
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: "Release"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
            ENABLE_SANITIZERS: "address,undefined"
          - lto_flag: ""
            label: bun-webkit-linux-arm64-asan
            os: ubuntu-24.04-arm
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: "Release"
            RELEASE_FLAGS: "-O3 -DNDEBUG=1"
            ENABLE_SANITIZERS: "address,undefined"
    steps:
      - name: Checkout libbun-webkit
        uses: actions/checkout@v4
        with:
          path: libbun-webkit

      - name: Clone WebKit
        uses: actions/checkout@v4
        with:
          repository: oven-sh/WebKit
          ref: ${{ inputs.webkit_sha }}
          path: webkit
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            /*
            !LayoutTests/
            !JSTests/

      - name: Apply patches
        run: |
          cd webkit
          for patch in ${{ github.workspace }}/libbun-webkit/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying patch: $patch"
              git apply "$patch" || git apply --3way "$patch" 2>/dev/null || echo "Patch $patch may not apply cleanly"
            fi
          done

      - uses: docker/setup-buildx-action@v2
        id: buildx
        with:
          install: true

      - name: Build
        env:
          RELEASE_FLAGS: ${{matrix.RELEASE_FLAGS}}
          ENABLE_SANITIZERS: ${{matrix.ENABLE_SANITIZERS}}
        run: |
          rm -rf ${{runner.temp}}/bun-webkit ${{runner.temp}}/bun-webkit.tar.gz
          cd webkit
          WEBKIT_RELEASE_TYPE=${{matrix.CMAKE_BUILD_TYPE}} CPU="native" cpu=native LTO_FLAG="${{matrix.lto_flag}}" temp=${{runner.temp}} ENABLE_SANITIZERS="${{matrix.ENABLE_SANITIZERS}}" bash release.sh
          cd ${{runner.temp}}
          echo "#define BUN_WEBKIT_VERSION \"${{ inputs.webkit_sha }}\"" >> bun-webkit/include/cmakeconfig.h
          echo '{ "name": "${{matrix.label}}", "version": "0.0.1-${{ inputs.webkit_sha }}", "os": ["linux"], "cpu": ["${{matrix.package_json_arch}}"], "repository": "https://github.com/${{github.repository}}" }' > bun-webkit/package.json
          rm -rf bun-webkit/lib/*.so
          rm -rf bun-webkit/lib/*.so.*
          tar -czf bun-webkit.tar.gz bun-webkit
          rm -rf bun-webkit

      - uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.label}}
          path: ${{runner.temp}}/bun-webkit.tar.gz

  windows:
    name: Windows
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: windows-latest
            build-type: Release
            package_json_arch: "x64"
            label: bun-webkit-windows-amd64
          - runner: windows-latest
            build-type: Debug
            package_json_arch: "x64"
            label: bun-webkit-windows-amd64-debug
    steps:
      - name: Checkout libbun-webkit
        uses: actions/checkout@v4
        with:
          path: libbun-webkit

      - name: Clone WebKit
        uses: actions/checkout@v4
        with:
          repository: oven-sh/WebKit
          ref: ${{ inputs.webkit_sha }}
          path: webkit
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            /*
            !LayoutTests/
            !JSTests/

      - name: Apply patches
        shell: bash
        run: |
          cd webkit
          for patch in ${{ github.workspace }}/libbun-webkit/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying patch: $patch"
              git apply "$patch" || git apply --3way "$patch" 2>/dev/null || echo "Patch $patch may not apply cleanly"
            fi
          done

      - name: Install Scoop
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
          Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
          Join-Path (Resolve-Path ~).Path "scoop\shims" >> $Env:GITHUB_PATH

      - name: Install LLVM and Ninja
        run: |
          scoop install ninja
          scoop install llvm@19.1.7
          Join-Path (Resolve-Path ~).Path "scoop\apps\llvm\current\bin" >> $Env:GITHUB_PATH

      - uses: cygwin/cygwin-install-action@006ad0b0946ca6d0a3ea2d4437677fa767392401

      - name: Build WebKit
        working-directory: webkit
        run: |
          $env:Path = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\;" + $env:Path
          $env:WEBKIT_OUTPUT_DIR = "bun-webkit"
          $env:BUN_WEBKIT_VERSION = "${{ inputs.webkit_sha }}"
          $env:CMAKE_BUILD_TYPE = "${{matrix.build-type}}"
          $env:PACKAGE_JSON_LABEL = "${{matrix.label}}"
          $env:GITHUB_SHA = "${{ inputs.webkit_sha }}"
          $env:PACKAGE_JSON_ARCH = "${{matrix.package_json_arch}}"
          $env:GITHUB_REPOSITORY = "${{ github.repository }}"
          ./windows-release.ps1

      - uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.label}}
          path: webkit/bun-webkit.tar.gz

  linux-musl:
    name: Linux musl
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - lto_flag: ""
            label: bun-webkit-linux-amd64-musl-debug
            os: ubuntu-latest
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: "Debug"
          - lto_flag: ""
            label: bun-webkit-linux-arm64-musl-debug
            os: ubuntu-24.04-arm
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: "Debug"
          # LTO builds commented out - require more memory than GitHub runners provide
          # - lto_flag: "-flto=full -fwhole-program-vtables -fforce-emit-vtables"
          #   label: bun-webkit-linux-arm64-musl-lto
          #   os: ubuntu-24.04-arm
          #   package_json_arch: "arm64"
          #   CMAKE_BUILD_TYPE: "MinSizeRel"
          - lto_flag: ""
            label: bun-webkit-linux-arm64-musl
            os: ubuntu-24.04-arm
            package_json_arch: "arm64"
            CMAKE_BUILD_TYPE: "MinSizeRel"
          # - lto_flag: "-flto=full -fwhole-program-vtables -fforce-emit-vtables"
          #   label: bun-webkit-linux-amd64-musl-lto
          #   os: ubuntu-latest
          #   package_json_arch: "x64"
          #   CMAKE_BUILD_TYPE: "MinSizeRel"
          - lto_flag: ""
            label: bun-webkit-linux-amd64-musl
            os: ubuntu-latest
            package_json_arch: "x64"
            CMAKE_BUILD_TYPE: "MinSizeRel"
    steps:
      - name: Checkout libbun-webkit
        uses: actions/checkout@v4
        with:
          path: libbun-webkit

      - name: Clone WebKit
        uses: actions/checkout@v4
        with:
          repository: oven-sh/WebKit
          ref: ${{ inputs.webkit_sha }}
          path: webkit
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            /*
            !LayoutTests/
            !JSTests/

      - name: Apply patches
        run: |
          cd webkit
          for patch in ${{ github.workspace }}/libbun-webkit/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying patch: $patch"
              git apply "$patch" || git apply --3way "$patch" 2>/dev/null || echo "Patch $patch may not apply cleanly"
            fi
          done

      - uses: docker/setup-buildx-action@v2
        id: buildx
        with:
          install: true

      - name: Build
        run: |
          rm -rf ${{runner.temp}}/bun-webkit ${{runner.temp}}/bun-webkit.tar.gz
          cd webkit
          WEBKIT_RELEASE_TYPE=${{matrix.CMAKE_BUILD_TYPE}} CPU="native" cpu=native LTO_FLAG="${{matrix.lto_flag}}" temp=${{runner.temp}} bash musl-release.sh
          cd ${{runner.temp}}
          echo "#define BUN_WEBKIT_VERSION \"${{ inputs.webkit_sha }}\"" >> bun-webkit/include/cmakeconfig.h
          echo '{ "name": "${{matrix.label}}", "version": "0.0.1-${{ inputs.webkit_sha }}", "os": ["linux"], "cpu": ["${{matrix.package_json_arch}}"], "repository": "https://github.com/${{github.repository}}" }' > bun-webkit/package.json
          rm -rf bun-webkit/lib/*.so
          rm -rf bun-webkit/lib/*.so.*
          tar -czf bun-webkit.tar.gz bun-webkit
          rm -rf bun-webkit

      - uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.label}}
          path: ${{runner.temp}}/bun-webkit.tar.gz

  release:
    name: Release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - linux
      - macos
      - windows
      - linux-musl
    outputs:
      tag: ${{ steps.release_info.outputs.tag }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-amd64
          path: ${{runner.temp}}/bun-webkit-linux-amd64
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-arm64
          path: ${{runner.temp}}/bun-webkit-linux-arm64
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-amd64-debug
          path: ${{runner.temp}}/bun-webkit-linux-amd64-debug
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-amd64-debug-asan
          path: ${{runner.temp}}/bun-webkit-linux-amd64-debug-asan
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-arm64-debug
          path: ${{runner.temp}}/bun-webkit-linux-arm64-debug
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-arm64-debug-asan
          path: ${{runner.temp}}/bun-webkit-linux-arm64-debug-asan
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-macos-arm64
          path: ${{runner.temp}}/bun-webkit-macos-arm64
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-macos-arm64-asan
          path: ${{runner.temp}}/bun-webkit-macos-arm64-asan
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-macos-arm64-debug
          path: ${{runner.temp}}/bun-webkit-macos-arm64-debug
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-macos-arm64-debug-asan
          path: ${{runner.temp}}/bun-webkit-macos-arm64-debug-asan
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-amd64-asan
          path: ${{runner.temp}}/bun-webkit-linux-amd64-asan
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-arm64-asan
          path: ${{runner.temp}}/bun-webkit-linux-arm64-asan
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-macos-amd64-debug
          path: ${{runner.temp}}/bun-webkit-macos-amd64-debug
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-macos-amd64
          path: ${{runner.temp}}/bun-webkit-macos-amd64
      # LTO builds commented out - require more memory than GitHub runners provide
      # - uses: actions/download-artifact@v4
      #   with:
      #     name: bun-webkit-linux-amd64-lto
      #     path: ${{runner.temp}}/bun-webkit-linux-amd64-lto
      # - uses: actions/download-artifact@v4
      #   with:
      #     name: bun-webkit-linux-arm64-lto
      #     path: ${{runner.temp}}/bun-webkit-linux-arm64-lto
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-windows-amd64
          path: ${{runner.temp}}/bun-webkit-windows-amd64
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-windows-amd64-debug
          path: ${{runner.temp}}/bun-webkit-windows-amd64-debug
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-amd64-musl
          path: ${{runner.temp}}/bun-webkit-linux-amd64-musl
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-arm64-musl
          path: ${{runner.temp}}/bun-webkit-linux-arm64-musl
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-amd64-musl-debug
          path: ${{runner.temp}}/bun-webkit-linux-amd64-musl-debug
      - uses: actions/download-artifact@v4
        with:
          name: bun-webkit-linux-arm64-musl-debug
          path: ${{runner.temp}}/bun-webkit-linux-arm64-musl-debug
      # - uses: actions/download-artifact@v4
      #   with:
      #     name: bun-webkit-linux-amd64-musl-lto
      #     path: ${{runner.temp}}/bun-webkit-linux-amd64-musl-lto
      # - uses: actions/download-artifact@v4
      #   with:
      #     name: bun-webkit-linux-arm64-musl-lto
      #     path: ${{runner.temp}}/bun-webkit-linux-arm64-musl-lto

      - name: Rename files
        run: |
          mkdir -p out
          mv ${{runner.temp}}/bun-webkit-linux-amd64/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-arm64/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-amd64-musl/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64-musl.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-arm64-musl/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64-musl.tar.gz
          mv ${{runner.temp}}/bun-webkit-macos-arm64/bun-webkit.tar.gz ./out/bun-webkit-macos-arm64.tar.gz
          mv ${{runner.temp}}/bun-webkit-macos-arm64-asan/bun-webkit.tar.gz ./out/bun-webkit-macos-arm64-asan.tar.gz
          mv ${{runner.temp}}/bun-webkit-macos-amd64/bun-webkit.tar.gz ./out/bun-webkit-macos-amd64.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-amd64-debug-asan/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64-debug-asan.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-arm64-debug-asan/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64-debug-asan.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-amd64-debug/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64-debug.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-arm64-debug/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64-debug.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-amd64-musl-debug/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64-musl-debug.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-arm64-musl-debug/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64-musl-debug.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-amd64-asan/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64-asan.tar.gz
          mv ${{runner.temp}}/bun-webkit-linux-arm64-asan/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64-asan.tar.gz
          mv ${{runner.temp}}/bun-webkit-macos-arm64-debug/bun-webkit.tar.gz ./out/bun-webkit-macos-arm64-debug.tar.gz
          mv ${{runner.temp}}/bun-webkit-macos-arm64-debug-asan/bun-webkit.tar.gz ./out/bun-webkit-macos-arm64-debug-asan.tar.gz
          mv ${{runner.temp}}/bun-webkit-macos-amd64-debug/bun-webkit.tar.gz ./out/bun-webkit-macos-amd64-debug.tar.gz
          # LTO builds commented out
          # mv ${{runner.temp}}/bun-webkit-linux-amd64-lto/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64-lto.tar.gz
          # mv ${{runner.temp}}/bun-webkit-linux-arm64-lto/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64-lto.tar.gz
          # mv ${{runner.temp}}/bun-webkit-linux-amd64-musl-lto/bun-webkit.tar.gz ./out/bun-webkit-linux-amd64-musl-lto.tar.gz
          # mv ${{runner.temp}}/bun-webkit-linux-arm64-musl-lto/bun-webkit.tar.gz ./out/bun-webkit-linux-arm64-musl-lto.tar.gz
          mv ${{runner.temp}}/bun-webkit-windows-amd64/bun-webkit.tar.gz ./out/bun-webkit-windows-amd64.tar.gz
          mv ${{runner.temp}}/bun-webkit-windows-amd64-debug/bun-webkit.tar.gz ./out/bun-webkit-windows-amd64-debug.tar.gz

      - name: Set release info
        id: release_info
        run: |
          echo "tag=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          tag_name: ${{ inputs.release_tag }}
          prerelease: ${{ inputs.is_prerelease }}
          body: |
            ## libbun-webkit
            
            WebKit build for use as a Node.js native addon (`.node` file).
            
            **Upstream WebKit SHA:** `${{ inputs.webkit_sha }}`
            **Upstream Repository:** https://github.com/oven-sh/WebKit
            
            ### Key Differences from oven-sh/WebKit
            
            - Built with `-ftls-model=global-dynamic` for `dlopen()` compatibility
            - Includes `webkit-runloop.patch` bug fix

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: |
            ./out/bun-webkit-linux-amd64.tar.gz
            ./out/bun-webkit-linux-arm64.tar.gz
            ./out/bun-webkit-linux-amd64-asan.tar.gz
            ./out/bun-webkit-linux-arm64-asan.tar.gz
            ./out/bun-webkit-linux-amd64-debug.tar.gz
            ./out/bun-webkit-linux-arm64-debug.tar.gz
            ./out/bun-webkit-linux-amd64-debug-asan.tar.gz
            ./out/bun-webkit-linux-arm64-debug-asan.tar.gz

      - name: Upload Linux musl artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: |
            ./out/bun-webkit-linux-amd64-musl.tar.gz
            ./out/bun-webkit-linux-arm64-musl.tar.gz
            ./out/bun-webkit-linux-amd64-musl-debug.tar.gz
            ./out/bun-webkit-linux-arm64-musl-debug.tar.gz

      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: |
            ./out/bun-webkit-macos-arm64.tar.gz
            ./out/bun-webkit-macos-arm64-asan.tar.gz
            ./out/bun-webkit-macos-arm64-debug.tar.gz
            ./out/bun-webkit-macos-arm64-debug-asan.tar.gz
            ./out/bun-webkit-macos-amd64.tar.gz
            ./out/bun-webkit-macos-amd64-debug.tar.gz

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag }}
          files: |
            ./out/bun-webkit-windows-amd64.tar.gz
            ./out/bun-webkit-windows-amd64-debug.tar.gz
