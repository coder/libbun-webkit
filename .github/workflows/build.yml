name: CI

on:
  # Check for updates every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  
  # Manual trigger with optional SHA override
  workflow_dispatch:
    inputs:
      webkit_sha:
        description: 'WebKit commit SHA to build (leave empty for latest main)'
        required: false
        default: ''
      force_build:
        description: 'Force build even if release exists'
        required: false
        default: 'false'
        type: boolean
      llvm_version:
        description: 'LLVM version'
        default: '19'

jobs:
  check:
    name: Check for Updates
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      webkit_sha: ${{ steps.check.outputs.webkit_sha }}
      release_tag: ${{ steps.check.outputs.release_tag }}
    steps:
      - name: Get latest WebKit SHA
        id: get_sha
        run: |
          if [ -n "${{ inputs.webkit_sha }}" ]; then
            SHA="${{ inputs.webkit_sha }}"
          else
            SHA=$(git ls-remote https://github.com/oven-sh/WebKit.git refs/heads/main | cut -f1)
          fi
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Latest WebKit SHA: $SHA"

      - name: Check if release exists
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.get_sha.outputs.sha }}"
          RELEASE_TAG="autobuild-$SHA"
          
          echo "webkit_sha=$SHA" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          
          # Check if release already exists
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "Force build requested"
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif gh release view "$RELEASE_TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Release $RELEASE_TAG already exists, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Release $RELEASE_TAG does not exist, triggering build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build and Release
    needs: check
    if: needs.check.outputs.should_build == 'true'
    permissions:
      contents: write
    uses: ./.github/workflows/build-reusable.yml
    with:
      webkit_sha: ${{ needs.check.outputs.webkit_sha }}
      release_tag: ${{ needs.check.outputs.release_tag }}
      is_prerelease: false
      llvm_version: ${{ inputs.llvm_version || '19' }}

